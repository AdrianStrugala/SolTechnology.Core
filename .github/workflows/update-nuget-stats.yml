name: Update NuGet Statistics

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Fetch NuGet Statistics
      shell: pwsh
      run: |
        $owner = "AdrianStrugala"
        $prefix = "SolTechnology."
        
        # Szukaj pakiet√≥w
        $searchUrl = "https://api-v2v3search-0.nuget.org/query?q=owner:$owner&take=100"
        $searchResult = Invoke-RestMethod -Uri $searchUrl
        
        $packages = @()
        $totalDownloads = 0
        
        foreach ($package in $searchResult.data) {
            if ($package.id -like "$prefix*") {
                Write-Host "Processing: $($package.id) - $($package.totalDownloads.ToString('N0')) downloads"
                
                $totalDownloads += $package.totalDownloads
                
                $packages += @{
                    id = $package.id
                    downloads = $package.totalDownloads
                    version = $package.version
                }
            }
        }
        
        # Posortuj po liczbie pobra≈Ñ
        $packages = $packages | Sort-Object { $_.downloads } -Descending
        
        # Stw√≥rz obiekt wynikowy
        $result = @{
            totals = @{
                downloads = $totalDownloads
                packages = $packages.Count
            }
            packages = $packages
            lastUpdated = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
        }
        
        # Zapisz do pliku
        $result | ConvertTo-Json -Depth 10 | Set-Content "nuget-stats.json"
        
        # Poka≈º podsumowanie
        Write-Host "`nüìä Summary:"
        Write-Host "Total packages: $($packages.Count)"
        Write-Host "Total downloads: $($totalDownloads.ToString('N0'))"

    - name: Commit and push if changed
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add nuget-stats.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "chore: Update NuGet statistics [skip ci]" && git push)