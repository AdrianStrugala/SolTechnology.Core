@using DreamTravel.Ui.Models

<MudPaper Class="pa-0" Elevation="2" Style="height: 100%; display: flex; flex-direction: column;">

    <!-- Header -->
    <MudPaper Class="pa-3 pb-2" Elevation="0" Square="true">
        <MudText Typo="Typo.h6" Class="mb-1">
            <MudIcon Icon="@Icons.Material.Filled.Route" Size="Size.Small" Class="mr-1" />
            Trip Planner
        </MudText>
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            Click on map or type city names
        </MudText>
    </MudPaper>

    <MudDivider />

    <!-- Scrollable Cities List - MAXIMUM SPACE -->
    <div style="flex: 1 1 auto; min-height: 0; overflow-y: auto; overflow-x: hidden; padding: 10px; scroll-behavior: smooth;" id="cities-scroll-container">
        @foreach (var city in Cities)
        {
            <div class="city-item @(city.IsSearching ? "city-searching" : "") @(IsLoading ? "city-loading" : "")"
                 style="@GetCityItemStyle(city)">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <!-- City Number Badge -->
                    <div style="@($"min-width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-weight: 600; font-size: 14px; background: var(--mud-palette-primary); color: white;")">
                        @(city.Index + 1)
                    </div>

                    <!-- City Input -->
                    <MudTextField @bind-Value="city.Name"
                                  Label="@($"City {city.Index + 1}")"
                                  Variant="Variant.Outlined"
                                  Immediate="true"
                                  Disabled="@IsLoading"
                                  OnBlur="@(() => OnCityChanged.InvokeAsync(city))"
                                  OnKeyUp="@(e => HandleKeyUp(e, city))"
                                  Style="flex: 1;"
                                  id="@($"city-input-{city.Index}")" />

                    <!-- Remove Button -->
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   Disabled="@IsLoading"
                                   OnClick="@(() => OnCityRemoved.InvokeAsync(city.Index))" />
                </MudStack>
            </div>
        }
    </div>

    <MudDivider />

    <!-- Compact Action Buttons -->
    <div style="padding: 10px; background: var(--mud-palette-background);">
        <!-- Results Section (if available) - Inline -->
        @if (!string.IsNullOrEmpty(TotalTime))
        {
            <div style="padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 15px; font-weight: 500; display: flex; justify-content: space-between; align-items: center;">
                <span style="display: flex; align-items: center; gap: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Medium" />
                    @TotalTime
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Medium" />
                    @TotalCost.ToString("F2") DKK
                </span>
            </div>
        }

        <MudStack Spacing="2">
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Color="Color.Success"
                       Variant="Variant.Outlined"
                       OnClick="@(() => OnCityAdded.InvokeAsync())"
                       Disabled="@IsLoading"
                       FullWidth="true"
                       Size="Size.Medium">
                Add City
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Calculate"
                       OnClick="@(() => OnRunTsp.InvokeAsync())"
                       Disabled="@(IsLoading || Cities.Count(c => c.City != null) < 2)"
                       FullWidth="true"
                       Size="Size.Medium"
                       data-action="run-tsp">
                @if (IsLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Calculating...</span>
                }
                else
                {
                    <span>Calculate Route</span>
                }
            </MudButton>

            <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
                Ctrl+Enter to calculate
            </MudText>
        </MudStack>
    </div>
</MudPaper>

<style>
    .city-item {
        margin-bottom: 8px;
        padding: 6px;
    }

    .city-loading {
        opacity: 0.6;
        pointer-events: none;
    }

    @@keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(103, 58, 183, 0.4);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(103, 58, 183, 0);
        }
    }

    .city-searching {
        animation: pulse 1.5s infinite;
    }
</style>

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;

    [Parameter] public List<CityEntry> Cities { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string TotalTime { get; set; } = "";
    [Parameter] public double TotalCost { get; set; }
    [Parameter] public EventCallback OnCityAdded { get; set; }
    [Parameter] public EventCallback<int> OnCityRemoved { get; set; }
    [Parameter] public EventCallback<CityEntry> OnCityChanged { get; set; }
    [Parameter] public EventCallback OnRunTsp { get; set; }

    private string GetCityItemStyle(CityEntry city)
    {
        return "";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Ensure cities list starts from top
            await JS.InvokeVoidAsync("eval", @"
                var container = document.getElementById('cities-scroll-container');
                if (container) {
                    container.scrollTop = 0;
                }

                document.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        document.querySelector('[data-action=""run-tsp""]')?.click();
                    }
                });
            ");
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e, CityEntry city)
    {
        // Ctrl/Cmd + Enter: Run TSP
        if ((e.CtrlKey || e.MetaKey) && e.Key == "Enter")
        {
            if (!IsLoading && Cities.Count(c => c.City != null) >= 2)
            {
                await OnRunTsp.InvokeAsync();
            }
            return;
        }

        // Escape: Clear input
        if (e.Key == "Escape")
        {
            city.Name = string.Empty;
            city.City = null;
            StateHasChanged();
            return;
        }

        // Enter: Search and move to next
        if (e.Key == "Enter")
        {
            await OnCityChanged.InvokeAsync(city);

            // Wait for state update
            await Task.Delay(150);

            // Focus next field
            var nextIndex = city.Index + 1;
            var nextFieldId = $"city-input-{nextIndex}";

            try
            {
                await JS.InvokeVoidAsync("eval", $"document.getElementById('{nextFieldId}')?.focus()");
            }
            catch
            {
                // Ignore if field doesn't exist or focus fails
            }
        }
    }
}
